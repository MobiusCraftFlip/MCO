{"version":3,"sources":["../../src/config/passport.config.js"],"sourcesContent":["const LocalStategy = require(\"passport-local\").Strategy\nconst nodemailer = require(\"nodemailer\")\nconst User = require(\"../models/user.model\")\nconst config = require(\"../../config.json\")\n\nlet transporter = nodemailer.createTransport(config.nodemailer.config)\n\ntransporter.verify(function (error, success) {\n  if (error) {\n    console.log(error)\n  } else {\n    console.log(\"Server is ready to take our messages\")\n  }\n})\n\nmodule.exports = passport => {\n  passport.serializeUser((user, done) => done(null, user.id))\n  passport.deserializeUser((id, done) => {\n    User.findById(id, (err, user) => done(err, user))\n  })\n\n  // Signup\n  passport.use(\"local-signup\", new LocalStategy({\n    passReqToCallback: true\n  }, (req, username, password, done) => {\n    let newUser = new User({\n      username: username.toLocaleLowerCase(),\n      name: req.body.name,\n      email: req.body.email\n    })\n    newUser.password = newUser.generateHash(password)\n    newUser.save(err => {\n      if (err) throw err\n      return done(null, newUser)\n    })\n\n    const info = transporter.sendMail({\n      from: \"\\\"MCO\\\" <mco-noreply@mobius.ovh>\", // sender address\n      to: req.body.email, // list of receivers\n      subject: \"MCO user signup\", // Subject line\n      text: \"Thank you for signing up to MCO, if you did not mean to create an account, bad luck. If you are here without permission kindly go away. \\n \\n From \\n Mobius\", // plain text body\n    }).catch(console.warn)\n      .then((message) => {\n        console.log(\"Message sent: %s\", message.messageId)\n      })\n  }))\n\n  // Login\n  passport.use(\"local-login\", new LocalStategy({\n    passReqToCallback: true\n  }, (req, username, password, done) => {\n    User.findOne({\n      username: username.toLowerCase()\n    }, (err, user) => {\n      console.log(user)\n      if (err) throw err\n      // req.flash is the way to set flashdata using connect-flash\n      if (!user)\n        return done(null, false, req.flash(\"loginMessage\", \"No user found.\"))\n      if (!user.validatePassword(password))\n        return done(null, false, req.flash(\"loginMessage\", \"Oops! Wrong password.\")) // create the loginMessage and save it to session as flashdata\n\n      // all is well, return successful user\n      return done(null, user)\n    })\n  }))\n}"],"names":["LocalStategy","require","Strategy","nodemailer","User","config","transporter","createTransport","verify","error","success","console","log","module","exports","passport","serializeUser","user","done","id","deserializeUser","findById","err","use","passReqToCallback","req","username","password","newUser","toLocaleLowerCase","name","body","email","generateHash","save","info","sendMail","from","to","subject","text","catch","warn","then","message","messageId","findOne","toLowerCase","flash","validatePassword"],"mappings":";AAAA,MAAMA,eAAeC,QAAQ,kBAAkBC,QAAQ;AACvD,MAAMC,aAAaF,QAAQ;AAC3B,MAAMG,OAAOH,QAAQ;AACrB,MAAMI,SAASJ,QAAQ;AAEvB,IAAIK,cAAcH,WAAWI,eAAe,CAACF,OAAOF,UAAU,CAACE,MAAM;AAErEC,YAAYE,MAAM,CAAC,SAAUC,KAAK,EAAEC,OAAO;IACzC,IAAID,OAAO;QACTE,QAAQC,GAAG,CAACH;IACd,OAAO;QACLE,QAAQC,GAAG,CAAC;IACd;AACF;AAEAC,OAAOC,OAAO,GAAGC,CAAAA;IACfA,SAASC,aAAa,CAAC,CAACC,MAAMC,OAASA,KAAK,MAAMD,KAAKE,EAAE;IACzDJ,SAASK,eAAe,CAAC,CAACD,IAAID;QAC5Bd,KAAKiB,QAAQ,CAACF,IAAI,CAACG,KAAKL,OAASC,KAAKI,KAAKL;IAC7C;IAEA,SAAS;IACTF,SAASQ,GAAG,CAAC,gBAAgB,IAAIvB,aAAa;QAC5CwB,mBAAmB;IACrB,GAAG,CAACC,KAAKC,UAAUC,UAAUT;QAC3B,IAAIU,UAAU,IAAIxB,KAAK;YACrBsB,UAAUA,SAASG,iBAAiB;YACpCC,MAAML,IAAIM,IAAI,CAACD,IAAI;YACnBE,OAAOP,IAAIM,IAAI,CAACC,KAAK;QACvB;QACAJ,QAAQD,QAAQ,GAAGC,QAAQK,YAAY,CAACN;QACxCC,QAAQM,IAAI,CAACZ,CAAAA;YACX,IAAIA,KAAK,MAAMA;YACf,OAAOJ,KAAK,MAAMU;QACpB;QAEA,MAAMO,OAAO7B,YAAY8B,QAAQ,CAAC;YAChCC,MAAM;YACNC,IAAIb,IAAIM,IAAI,CAACC,KAAK;YAClBO,SAAS;YACTC,MAAM;QACR,GAAGC,KAAK,CAAC9B,QAAQ+B,IAAI,EAClBC,IAAI,CAAC,CAACC;YACLjC,QAAQC,GAAG,CAAC,oBAAoBgC,QAAQC,SAAS;QACnD;IACJ;IAEA,QAAQ;IACR9B,SAASQ,GAAG,CAAC,eAAe,IAAIvB,aAAa;QAC3CwB,mBAAmB;IACrB,GAAG,CAACC,KAAKC,UAAUC,UAAUT;QAC3Bd,KAAK0C,OAAO,CAAC;YACXpB,UAAUA,SAASqB,WAAW;QAChC,GAAG,CAACzB,KAAKL;YACPN,QAAQC,GAAG,CAACK;YACZ,IAAIK,KAAK,MAAMA;YACf,4DAA4D;YAC5D,IAAI,CAACL,MACH,OAAOC,KAAK,MAAM,OAAOO,IAAIuB,KAAK,CAAC,gBAAgB;YACrD,IAAI,CAAC/B,KAAKgC,gBAAgB,CAACtB,WACzB,OAAOT,KAAK,MAAM,OAAOO,IAAIuB,KAAK,CAAC,gBAAgB,0BAA0B,8DAA8D;;YAE7I,sCAAsC;YACtC,OAAO9B,KAAK,MAAMD;QACpB;IACF;AACF"}