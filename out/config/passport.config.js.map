{"version":3,"sources":["../../src/config/passport.config.ts"],"sourcesContent":["import { Request } from \"express\"\n\nimport { Strategy as LocalStategy } from \"passport-local\"\nimport User from \"../models/user.model\"\nconst { RedisFlushModes } = require(\"redis\")\nimport { transporter } from \"./smtp.config\"\n\nimport type Passport from \"passport\"\nimport redisClient from \"./redis.config\"\n\nmodule.exports = (passport: typeof Passport) => {\n  passport.serializeUser((user, done) => done(null, user.id))\n  passport.deserializeUser((id, done) => {\n    // User.findById(id, (err, user) => done(err, user))\n    User.findById(id).exec().then((user) => done(undefined, user)).catch((err) => done(err))\n  })\n\n  // Signup\n  passport.use(\"local-signup\", new LocalStategy({\n    passReqToCallback: true\n  }, async (req, username, password, done) => {\n    username = username.trim().toLowerCase()\n    if (!((/^[a-z]([a-z0-9]|_)+$/).test(username))) {\n      return done(null, false, req.flash(\"loginMessage\", \"Invalid username\")) \n    }\n    let newUser = new User({\n      username: username,\n      name: req.body.name,\n      email: req.body.email\n    })\n    newUser.password = newUser.generateHash(password)\n    await newUser.save()\n\n    const info = transporter.sendMail({\n      from: \"\\\"MCO\\\" <mco-noreply@mobius.ovh>\", // sender address\n      to: req.body.email, // list of receivers\n      subject: \"MCO user signup\", // Subject line\n      text: \"Thank you for signing up to MCO, if you did not mean to create an account, bad luck. If you are here without permission kindly go away. \\n \\n From \\n Mobius\", // plain text body\n    }).catch(console.warn)\n      .then((message) => {\n        console.log(\"Message sent: %s\", message?.messageId)\n      })\n    return done(null, newUser)\n  }))\n\n  // Login\n  passport.use(\"local-login\", new LocalStategy({\n    passReqToCallback: true\n  }, async (req: Request, username: string, password: string, done) => {\n    const key = `mco-login-attempts:${req.ip.replaceAll(\":\", \".\")}-${encodeURIComponent(username)}`\n    console.log(req.ip)\n    const attempts = parseInt(await redisClient.get(key))\n    if (attempts >= 5) {\n      return done(null, false, req.flash(\"loginMessage\", \"Woah! Slow down there buddy, please wait a couple minutes before trying again\")) // create the loginMessage and save it to session as flashdata\n    }\n    const user = await User.findOne({\n      username: username.toLowerCase()}).exec()\n      console.log(user)\n    // req.flash is the way to set flashdata using connect-flash\n    if (!user) {\n      return done(null, false, req.flash(\"loginMessage\", \"No user found.\"))\n    }\n    if (user.disabled) {\n      return done(null, false, req.flash(\"loginMessage\", `User is disabled: ${user.disabledReason}`))\n    }\n    if (!user.validatePassword(password)) {\n      redisClient.multi().incr(key).expire(key, 120).exec()\n        \n      return done(null, false, req.flash(\"loginMessage\", \"Oops! Wrong password.\")) // create the loginMessage and save it to session as flashdata\n    }\n    // all is well, return successful user\n    return done(null, user)\n  }))\n}"],"names":["RedisFlushModes","require","module","exports","passport","serializeUser","user","done","id","deserializeUser","User","findById","exec","then","undefined","catch","err","use","LocalStategy","passReqToCallback","req","username","password","trim","toLowerCase","test","flash","newUser","name","body","email","generateHash","save","info","transporter","sendMail","from","to","subject","text","console","warn","message","log","messageId","key","ip","replaceAll","encodeURIComponent","attempts","parseInt","redisClient","get","findOne","disabled","disabledReason","validatePassword","multi","incr","expire"],"mappings":";;;;+BAEyC;kEACxB;4BAEW;oEAGJ;;;;;;AAJxB,MAAM,EAAEA,eAAe,EAAE,GAAGC,QAAQ;AAMpCC,OAAOC,OAAO,GAAG,CAACC;IAChBA,SAASC,aAAa,CAAC,CAACC,MAAMC,OAASA,KAAK,MAAMD,KAAKE,EAAE;IACzDJ,SAASK,eAAe,CAAC,CAACD,IAAID;QAC5B,oDAAoD;QACpDG,kBAAI,CAACC,QAAQ,CAACH,IAAII,IAAI,GAAGC,IAAI,CAAC,CAACP,OAASC,KAAKO,WAAWR,OAAOS,KAAK,CAAC,CAACC,MAAQT,KAAKS;IACrF;IAEA,SAAS;IACTZ,SAASa,GAAG,CAAC,gBAAgB,IAAIC,uBAAY,CAAC;QAC5CC,mBAAmB;IACrB,GAAG,OAAOC,KAAKC,UAAUC,UAAUf;QACjCc,WAAWA,SAASE,IAAI,GAAGC,WAAW;QACtC,IAAI,CAAE,AAAC,uBAAwBC,IAAI,CAACJ,WAAY;YAC9C,OAAOd,KAAK,MAAM,OAAOa,IAAIM,KAAK,CAAC,gBAAgB;QACrD;QACA,IAAIC,UAAU,IAAIjB,kBAAI,CAAC;YACrBW,UAAUA;YACVO,MAAMR,IAAIS,IAAI,CAACD,IAAI;YACnBE,OAAOV,IAAIS,IAAI,CAACC,KAAK;QACvB;QACAH,QAAQL,QAAQ,GAAGK,QAAQI,YAAY,CAACT;QACxC,MAAMK,QAAQK,IAAI;QAElB,MAAMC,OAAOC,uBAAW,CAACC,QAAQ,CAAC;YAChCC,MAAM;YACNC,IAAIjB,IAAIS,IAAI,CAACC,KAAK;YAClBQ,SAAS;YACTC,MAAM;QACR,GAAGxB,KAAK,CAACyB,QAAQC,IAAI,EAClB5B,IAAI,CAAC,CAAC6B;YACLF,QAAQG,GAAG,CAAC,oBAAoBD,SAASE;QAC3C;QACF,OAAOrC,KAAK,MAAMoB;IACpB;IAEA,QAAQ;IACRvB,SAASa,GAAG,CAAC,eAAe,IAAIC,uBAAY,CAAC;QAC3CC,mBAAmB;IACrB,GAAG,OAAOC,KAAcC,UAAkBC,UAAkBf;QAC1D,MAAMsC,MAAM,CAAC,mBAAmB,EAAEzB,IAAI0B,EAAE,CAACC,UAAU,CAAC,KAAK,KAAK,CAAC,EAAEC,mBAAmB3B,UAAU,CAAC;QAC/FmB,QAAQG,GAAG,CAACvB,IAAI0B,EAAE;QAClB,MAAMG,WAAWC,SAAS,MAAMC,oBAAW,CAACC,GAAG,CAACP;QAChD,IAAII,YAAY,GAAG;YACjB,OAAO1C,KAAK,MAAM,OAAOa,IAAIM,KAAK,CAAC,gBAAgB,kFAAkF,8DAA8D;;QACrM;QACA,MAAMpB,OAAO,MAAMI,kBAAI,CAAC2C,OAAO,CAAC;YAC9BhC,UAAUA,SAASG,WAAW;QAAE,GAAGZ,IAAI;QACvC4B,QAAQG,GAAG,CAACrC;QACd,4DAA4D;QAC5D,IAAI,CAACA,MAAM;YACT,OAAOC,KAAK,MAAM,OAAOa,IAAIM,KAAK,CAAC,gBAAgB;QACrD;QACA,IAAIpB,KAAKgD,QAAQ,EAAE;YACjB,OAAO/C,KAAK,MAAM,OAAOa,IAAIM,KAAK,CAAC,gBAAgB,CAAC,kBAAkB,EAAEpB,KAAKiD,cAAc,CAAC,CAAC;QAC/F;QACA,IAAI,CAACjD,KAAKkD,gBAAgB,CAAClC,WAAW;YACpC6B,oBAAW,CAACM,KAAK,GAAGC,IAAI,CAACb,KAAKc,MAAM,CAACd,KAAK,KAAKjC,IAAI;YAEnD,OAAOL,KAAK,MAAM,OAAOa,IAAIM,KAAK,CAAC,gBAAgB,0BAA0B,8DAA8D;;QAC7I;QACA,sCAAsC;QACtC,OAAOnB,KAAK,MAAMD;IACpB;AACF"}