{"version":3,"sources":["../../src/routes/gloc.js"],"sourcesContent":["const { Mongoose } = require(\"mongoose\")\nconst { createConnection, MongoClient, ServerApiVersion } = require(\"mongodb\")\nconst { Router } = require(\"express\")\nconst { getUsernameFromId } = require(\"noblox.js\")\n\nconst {check} = require(\"../util/permissions\")\nconst { unautherisedRedirect } = require(\"../util/express\")\n\nconst uri = process.env.MOKORE_URI\nconst client = new MongoClient(uri,  {\n  serverApi: {\n    version: ServerApiVersion.v1,\n    strict: true,\n    deprecationErrors: true,\n  }\n})\n\nlet connected = false\nconst Client = async () => {\n  if (connected) {\n    return client\n  } else {\n    await client.connect()\n    connected = true\n    return client\n  }\n}\n\nconst router = Router()\n\nrouter.get(\"/warnings\", async (req, res) => {\n  if (!req.isAuthenticated()) {\n    \n    return unautherisedRedirect(req,res)\n  }\n  if (req.user && req.user.flags && check(req.user, \"gloc.warnings.read\")) {\n    const warnings = await (await Client()).db(\"test\").collection(\"warning_entity\").find().sort({_id: -1}).limit(50).toArray()\n    const names = []\n    warnings.forEach((value, index) => {\n      names[index] = getUsernameFromId(value.userid)\n    })\n    let realNames\n    try {\n      realNames = await Promise.all(names)\n    } catch (error) {\n      try {\n        realNames = await Promise.all(names)\n      } catch (error) {\n        res.sendStatus(500)\n      }\n    }\n    realNames.forEach((name, index) => {\n      warnings[index].name = name\n    })\n    return res.render(\"gloc/warnings\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n      profile: null,\n      warnings: warnings,\n    })\n  } else {\n    \n    return unautherisedRedirect(req,res)\n  }\n})\n\nrouter.get(\"/players/:player\", async (req, res) => {\n  if (!req.isAuthenticated()) {\n    \n    return unautherisedRedirect(req,res)\n  }\n    \n  if (req.user && ((req.user.flags && check(req.user, \"gloc.warnings.read\") || req.user.roblox_id == req.params.player))) {\n        \n    const warnings = await (await Client()).db(\"test\").collection(\"warning_entity\").find({userid: req.params.player}).sort().toArray()\n        \n    const names = []\n    warnings.forEach((value, index) => {\n      names[index] = getUsernameFromId(value.userid)\n    })\n\n    const realNames = await Promise.all(names)\n    realNames.forEach((name, index) => {\n      warnings[index].name = name\n    })\n    return res.render(\"gloc/player\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n      profile: null,\n      warnings: warnings,\n    })\n  } else {\n    \n    return unautherisedRedirect(req,res)\n  }\n})\n\nmodule.exports = router"],"names":["Mongoose","require","createConnection","MongoClient","ServerApiVersion","Router","getUsernameFromId","check","unautherisedRedirect","uri","process","env","MOKORE_URI","client","serverApi","version","v1","strict","deprecationErrors","connected","Client","connect","router","get","req","res","isAuthenticated","user","flags","warnings","db","collection","find","sort","_id","limit","toArray","names","forEach","value","index","userid","realNames","Promise","all","error","sendStatus","name","render","isAuth","profile","roblox_id","params","player","module","exports"],"mappings":"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"}