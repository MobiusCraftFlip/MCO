{"version":3,"sources":["../../src/routes/roblox.js"],"sourcesContent":["const crypto = require(\"crypto\")\nconst fetch = require(\"node-fetch\")\nconst nonces = {}\n\nasync function getUserInfo(code) {\n  return await (await fetch(\"https://apis.roblox.com/oauth/v1/userinfo\", {\n    headers: {\n      Authorization: `Bearer ${code}`\n    }\n  })).json()\n}\n\nasync function getUserToken(code) {\n  return await (await fetch(\"https://apis.roblox.com/oauth/v1/token\", {\n    method: \"POST\",\n    body: new URLSearchParams({\n      grant_type: \"authorization_code\",\n      code: code,\n      client_id: process.env.ROBLOX_CLIENT_ID,\n      client_secret: process.env.ROBLOX_CLIENT_SECRET,\n    }),\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\"\n    },\n  })).json()\n}\n\nfunction generateOAuthURL(nonce) {\n  return `https://authorize.roblox.com?client_id=${process.env.ROBLOX_CLIENT_ID}&redirect_uri=${process.env.BASEURL + \"/roblox/redirect\"}&scope=openid+profile&response_type=Code&prompts=login+consent&state=${nonce}`\n}\n\nmodule.exports = (app, passport, UserModel) => {\n  app.get(\"/roblox/link\", (req,res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    const nonce = crypto.randomBytes(16).toString(\"base64url\")\n    nonces[nonce] = {\n      _id: req.user._id,\n      username: req.user.username,\n    }\n\n    res.redirect(generateOAuthURL(\n      nonce,\n    ))\n  })\n\n  app.get(\"/roblox/redirect\", async (req,res) => {\n    // res.send(req.query)\n    const code = req.query.code\n    if (typeof code == \"string\") {\n      const tokenResponse = await getUserToken(code)\n      const userinfo =  await getUserInfo(tokenResponse.access_token)\n      const nonceinfo = nonces[req.query.state]\n      if (nonceinfo && userinfo.name && userinfo.nickname && userinfo.preferred_username) {\n        const user = await UserModel.findOne({\n          _id: nonceinfo._id\n        }).exec()\n        user.roblox_username = userinfo.preferred_username\n        user.roblox_id = userinfo.sub\n        user.roblox_displayname = userinfo.nickname\n        await user.save()\n        return res.redirect(\"/profile\")\n      }\n\n      res.send(userinfo)\n    }\n  })\n}"],"names":["crypto","require","fetch","nonces","getUserInfo","code","headers","Authorization","json","getUserToken","method","body","URLSearchParams","grant_type","client_id","process","env","ROBLOX_CLIENT_ID","client_secret","ROBLOX_CLIENT_SECRET","generateOAuthURL","nonce","BASEURL","module","exports","app","passport","UserModel","get","req","res","isAuthenticated","render","isAuth","user","profile","randomBytes","toString","_id","username","redirect","query","tokenResponse","userinfo","access_token","nonceinfo","state","name","nickname","preferred_username","findOne","exec","roblox_username","roblox_id","sub","roblox_displayname","save","send"],"mappings":"aAAA,MAAMA,OAASC,QAAQ,UACvB,MAAMC,MAAQD,QAAQ,cACtB,MAAME,OAAS,CAAC,EAEhB,eAAeC,YAAYC,IAAI,EAC7B,OAAO,MAAM,AAAC,CAAA,MAAMH,MAAM,4CAA6C,CACrEI,QAAS,CACPC,cAAe,CAAC,OAAO,EAAEF,KAAK,CAAC,AACjC,CACF,EAAC,EAAGG,IAAI,EACV,CAEA,eAAeC,aAAaJ,IAAI,EAC9B,OAAO,MAAM,AAAC,CAAA,MAAMH,MAAM,yCAA0C,CAClEQ,OAAQ,OACRC,KAAM,IAAIC,gBAAgB,CACxBC,WAAY,qBACZR,KAAMA,KACNS,UAAWC,QAAQC,GAAG,CAACC,gBAAgB,CACvCC,cAAeH,QAAQC,GAAG,CAACG,oBAAoB,AACjD,GACAb,QAAS,CACP,eAAgB,mCAClB,CACF,EAAC,EAAGE,IAAI,EACV,CAEA,SAASY,iBAAiBC,KAAK,EAC7B,MAAO,CAAC,uCAAuC,EAAEN,QAAQC,GAAG,CAACC,gBAAgB,CAAC,cAAc,EAAEF,QAAQC,GAAG,CAACM,OAAO,CAAG,mBAAmB,qEAAqE,EAAED,MAAM,CAAC,AACvN,CAEAE,OAAOC,OAAO,CAAG,CAACC,IAAKC,SAAUC,aAC/BF,IAAIG,GAAG,CAAC,eAAgB,CAACC,IAAIC,OAC3B,GAAI,CAACD,IAAIE,eAAe,GAAI,CAC1B,OAAOD,IAAIE,MAAM,CAAC,MAAO,CACvBC,OAAQJ,IAAIE,eAAe,GAC3BG,KAAML,IAAIK,IAAI,CACdC,QAAS,IACX,EACF,CACA,MAAMd,MAAQrB,OAAOoC,WAAW,CAAC,IAAIC,QAAQ,CAAC,YAC9ClC,CAAAA,MAAM,CAACkB,MAAM,CAAG,CACdiB,IAAKT,IAAIK,IAAI,CAACI,GAAG,CACjBC,SAAUV,IAAIK,IAAI,CAACK,QAAQ,AAC7B,EAEAT,IAAIU,QAAQ,CAACpB,iBACXC,OAEJ,GAEAI,IAAIG,GAAG,CAAC,mBAAoB,MAAOC,IAAIC,OAErC,MAAMzB,KAAOwB,IAAIY,KAAK,CAACpC,IAAI,CAC3B,GAAI,OAAOA,MAAQ,SAAU,CAC3B,MAAMqC,cAAgB,MAAMjC,aAAaJ,MACzC,MAAMsC,SAAY,MAAMvC,YAAYsC,cAAcE,YAAY,EAC9D,MAAMC,UAAY1C,MAAM,CAAC0B,IAAIY,KAAK,CAACK,KAAK,CAAC,CACzC,GAAID,WAAaF,SAASI,IAAI,EAAIJ,SAASK,QAAQ,EAAIL,SAASM,kBAAkB,CAAE,CAClF,MAAMf,KAAO,MAAMP,UAAUuB,OAAO,CAAC,CACnCZ,IAAKO,UAAUP,GAAG,AACpB,GAAGa,IAAI,EACPjB,CAAAA,KAAKkB,eAAe,CAAGT,SAASM,kBAAkB,AAClDf,CAAAA,KAAKmB,SAAS,CAAGV,SAASW,GAAG,AAC7BpB,CAAAA,KAAKqB,kBAAkB,CAAGZ,SAASK,QAAQ,AAC3C,OAAMd,KAAKsB,IAAI,GACf,OAAO1B,IAAIU,QAAQ,CAAC,WACtB,CAEAV,IAAI2B,IAAI,CAACd,SACX,CACF,EACF"}