{"version":3,"sources":["../../src/routes/roblox.js"],"sourcesContent":["const crypto = require(\"crypto\")\nconst fetch = require(\"node-fetch\")\nconst nonces = {}\n\nasync function getUserInfo(code) {\n  return await (await fetch(\"https://apis.roblox.com/oauth/v1/userinfo\", {\n    headers: {\n      Authorization: `Bearer ${code}`\n    }\n  })).json()\n}\n\nasync function getUserToken(code) {\n  return await (await fetch(\"https://apis.roblox.com/oauth/v1/token\", {\n    method: \"POST\",\n    body: new URLSearchParams({\n      grant_type: \"authorization_code\",\n      code: code,\n      client_id: process.env.ROBLOX_CLIENT_ID,\n      client_secret: process.env.ROBLOX_CLIENT_SECRET,\n    }),\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\"\n    },\n  })).json()\n}\n\nfunction generateOAuthURL(nonce) {\n  return `https://authorize.roblox.com?client_id=${process.env.ROBLOX_CLIENT_ID}&redirect_uri=${process.env.BASEURL + \"/roblox/redirect\"}&scope=openid+profile&response_type=Code&prompts=login+consent&state=${nonce}`\n}\n\nmodule.exports = (app, passport, UserModel) => {\n  app.get(\"/roblox/link\", (req,res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    const nonce = crypto.randomBytes(16).toString(\"base64url\")\n    nonces[nonce] = {\n      _id: req.user._id,\n      username: req.user.username,\n    }\n\n    res.redirect(generateOAuthURL(\n      nonce,\n    ))\n  })\n\n  app.get(\"/roblox/redirect\", async (req,res) => {\n    // res.send(req.query)\n    const code = req.query.code\n    if (typeof code == \"string\") {\n      const tokenResponse = await getUserToken(code)\n      const userinfo =  await getUserInfo(tokenResponse.access_token)\n      const nonceinfo = nonces[req.query.state]\n      if (nonceinfo && userinfo.name && userinfo.nickname && userinfo.preferred_username) {\n        const user = await UserModel.findOne({\n          _id: nonceinfo._id\n        }).exec()\n        user.roblox_username = userinfo.preferred_username\n        user.roblox_id = userinfo.sub\n        user.roblox_displayname = userinfo.nickname\n        await user.save()\n        return res.redirect(\"/profile\")\n      }\n\n      res.send(userinfo)\n    }\n  })\n}"],"names":["crypto","require","fetch","nonces","getUserInfo","code","headers","Authorization","json","getUserToken","method","body","URLSearchParams","grant_type","client_id","process","env","ROBLOX_CLIENT_ID","client_secret","ROBLOX_CLIENT_SECRET","generateOAuthURL","nonce","BASEURL","module","exports","app","passport","UserModel","get","req","res","isAuthenticated","render","isAuth","user","profile","randomBytes","toString","_id","username","redirect","query","tokenResponse","userinfo","access_token","nonceinfo","state","name","nickname","preferred_username","findOne","exec","roblox_username","roblox_id","sub","roblox_displayname","save","send"],"mappings":";AAAA,MAAMA,SAASC,QAAQ;AACvB,MAAMC,QAAQD,QAAQ;AACtB,MAAME,SAAS,CAAC;AAEhB,eAAeC,YAAYC,IAAI;IAC7B,OAAO,MAAM,AAAC,CAAA,MAAMH,MAAM,6CAA6C;QACrEI,SAAS;YACPC,eAAe,CAAC,OAAO,EAAEF,KAAK,CAAC;QACjC;IACF,EAAC,EAAGG,IAAI;AACV;AAEA,eAAeC,aAAaJ,IAAI;IAC9B,OAAO,MAAM,AAAC,CAAA,MAAMH,MAAM,0CAA0C;QAClEQ,QAAQ;QACRC,MAAM,IAAIC,gBAAgB;YACxBC,YAAY;YACZR,MAAMA;YACNS,WAAWC,QAAQC,GAAG,CAACC,gBAAgB;YACvCC,eAAeH,QAAQC,GAAG,CAACG,oBAAoB;QACjD;QACAb,SAAS;YACP,gBAAgB;QAClB;IACF,EAAC,EAAGE,IAAI;AACV;AAEA,SAASY,iBAAiBC,KAAK;IAC7B,OAAO,CAAC,uCAAuC,EAAEN,QAAQC,GAAG,CAACC,gBAAgB,CAAC,cAAc,EAAEF,QAAQC,GAAG,CAACM,OAAO,GAAG,mBAAmB,qEAAqE,EAAED,MAAM,CAAC;AACvN;AAEAE,OAAOC,OAAO,GAAG,CAACC,KAAKC,UAAUC;IAC/BF,IAAIG,GAAG,CAAC,gBAAgB,CAACC,KAAIC;QAC3B,IAAI,CAACD,IAAIE,eAAe,IAAI;YAC1B,OAAOD,IAAIE,MAAM,CAAC,OAAO;gBACvBC,QAAQJ,IAAIE,eAAe;gBAC3BG,MAAML,IAAIK,IAAI;gBACdC,SAAS;YACX;QACF;QACA,MAAMd,QAAQrB,OAAOoC,WAAW,CAAC,IAAIC,QAAQ,CAAC;QAC9ClC,MAAM,CAACkB,MAAM,GAAG;YACdiB,KAAKT,IAAIK,IAAI,CAACI,GAAG;YACjBC,UAAUV,IAAIK,IAAI,CAACK,QAAQ;QAC7B;QAEAT,IAAIU,QAAQ,CAACpB,iBACXC;IAEJ;IAEAI,IAAIG,GAAG,CAAC,oBAAoB,OAAOC,KAAIC;QACrC,sBAAsB;QACtB,MAAMzB,OAAOwB,IAAIY,KAAK,CAACpC,IAAI;QAC3B,IAAI,OAAOA,QAAQ,UAAU;YAC3B,MAAMqC,gBAAgB,MAAMjC,aAAaJ;YACzC,MAAMsC,WAAY,MAAMvC,YAAYsC,cAAcE,YAAY;YAC9D,MAAMC,YAAY1C,MAAM,CAAC0B,IAAIY,KAAK,CAACK,KAAK,CAAC;YACzC,IAAID,aAAaF,SAASI,IAAI,IAAIJ,SAASK,QAAQ,IAAIL,SAASM,kBAAkB,EAAE;gBAClF,MAAMf,OAAO,MAAMP,UAAUuB,OAAO,CAAC;oBACnCZ,KAAKO,UAAUP,GAAG;gBACpB,GAAGa,IAAI;gBACPjB,KAAKkB,eAAe,GAAGT,SAASM,kBAAkB;gBAClDf,KAAKmB,SAAS,GAAGV,SAASW,GAAG;gBAC7BpB,KAAKqB,kBAAkB,GAAGZ,SAASK,QAAQ;gBAC3C,MAAMd,KAAKsB,IAAI;gBACf,OAAO1B,IAAIU,QAAQ,CAAC;YACtB;YAEAV,IAAI2B,IAAI,CAACd;QACX;IACF;AACF"}