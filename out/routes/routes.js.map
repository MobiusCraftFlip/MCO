{"version":3,"sources":["../../src/routes/routes.js"],"sourcesContent":["const {recaptcha, postMiddleware} = require(\"../config/recaptcha.config\")\nconst { check } = require(\"../util/permissions\")\nimport * as userStuff from \"../models/user.model\"\nconst flags = require(\"../util/flags\")\nmodule.exports = (app, passport, UserModel) => {\n\n  require(\"./admin\")(app, passport, UserModel)\n  require(\"./roblox\")(app, passport, UserModel)\n  require(\"./discord\")(app, passport, UserModel)\n\n  // Home Page\n  app.get(\"/\", (req, res) => res.render(\"home\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user\n  }))\n  // Home Page\n  app.get(\"/privacy\", (req, res) => res.redirect(process.env.PRIVACY_URL))\n  \n  app.get(\"/termsofservice\", (req, res) => res.redirect(process.env.TOS_URL))\n\n  // Login\n  app.get(\"/login\", (req, res) => res.render(\"login\", {\n    message: req.flash(\"loginMessage\"),\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY,\n    req\n  }))\n\n  app.post(\"/login\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-login\", {\n    failureRedirect: \"/login\", // redirect back to the signup page if there is an error\n    failureFlash: true // allow flash messages\n  }), (req, res) => {\n    console.log(req.query.redirect)\n    if (req.query.redirect) {\n      return res.redirect(req.query.redirect)\n    } else {\n      return res.redirect(\"/profile\")\n    }\n  })\n\n  // Signup\n  app.get(\"/signup\", (req, res) => res.render(\"signup\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY\n  }))\n\n  app.post(\"/signup\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-signup\", {\n    successRedirect: \"/profile\",\n    failureRedirect: \"/signup\"\n  }))\n\n  // Profile\n  app.get(\"/profile\", isLoggedIn, (req, res) => {\n    let redirectUrl = `/user/${req.user.username}`\n    res.redirect(redirectUrl)\n  })\n\n  app.get(\"/user/:username\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      console.log(doc)\n      res.render(\"profile\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: req.isAuthenticated() ? doc.username === req.user.username : false,\n        check,\n        flags\n      })\n    }\n  })\n\n  app.get(\"/user/:username/edit\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      if (!(req.user.flags.includes(\"sudo\") || req.user.username == doc.username)) {\n        return res.render(\"404\", {\n          isAuth: req.isAuthenticated(),\n          user: req.user,\n          profile: null,\n        })\n      }\n      console.log(doc)\n      res.render(\"user/edit\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: check(req.user, \"admin.user.edit.others\"),\n        userStuff,\n      })\n    }\n  })\n\n  app.get(\"/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\"/\")\n    })\n  })\n\n  app.get(\"/check-username-availability\", (req, res) => {\n    UserModel.find({}).then(users => {\n      let usernames = users.map(val => val.username.toLowerCase())\n      res.json(usernames)\n    })\n    .catch(err => {\n      console.warn(err)\n      res.sendStatus(500)\n    })\n  })\n\n  // About Page\n  app.get(\"/about\", (req, res) => {\n    res.render(\"about\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n\n\n  app.use(\"/gloc/\", require(\"./gloc\"))\n\n  app.get(\"*\", (req, res) => {\n    res.render(\"404\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n}\n\nfunction isLoggedIn(req, res, next) {\n  // if user is authenticated in the session, carry on \n  if (req.isAuthenticated())\n    return next()\n  // if they aren't redirect them to the home page\n  res.redirect(\"/\")\n}"],"names":["recaptcha","postMiddleware","require","check","flags","module","exports","app","passport","UserModel","get","req","res","render","isAuth","isAuthenticated","user","redirect","process","env","PRIVACY_URL","TOS_URL","message","flash","recaptcha_key","RECAPTCHA_KEY","post","middleware","verify","authenticate","failureRedirect","failureFlash","console","log","query","successRedirect","isLoggedIn","redirectUrl","username","profile","params","doc","findOne","isRoot","includes","userStuff","logout","find","then","users","usernames","map","val","toLowerCase","json","catch","err","warn","sendStatus","use","next"],"mappings":"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"}