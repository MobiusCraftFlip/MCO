{"version":3,"sources":["../../src/routes/routes.js"],"sourcesContent":["const {recaptcha, postMiddleware} = require(\"../config/recaptcha.config\")\nconst { check } = require(\"../util/permissions\")\nimport * as userStuff from \"../models/user.model\"\n\nmodule.exports = (app, passport, UserModel) => {\n\n  require(\"./admin\")(app, passport, UserModel)\n  require(\"./roblox\")(app, passport, UserModel)\n  require(\"./discord\")(app, passport, UserModel)\n\n  // Home Page\n  app.get(\"/\", (req, res) => res.render(\"home\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user\n  }))\n  // Home Page\n  app.get(\"/privacy\", (req, res) => res.redirect(process.env.PRIVACY_URL))\n  \n  app.get(\"/termsofservice\", (req, res) => res.redirect(process.env.TOS_URL))\n\n  // Login\n  app.get(\"/login\", (req, res) => res.render(\"login\", {\n    message: req.flash(\"loginMessage\"),\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY,\n    req\n  }))\n\n  app.post(\"/login\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-login\", {\n    failureRedirect: \"/login\", // redirect back to the signup page if there is an error\n    failureFlash: true // allow flash messages\n  }), (req, res) => {\n    console.log(req.query.redirect)\n    if (req.query.redirect) {\n      return res.redirect(req.query.redirect)\n    } else {\n      return res.redirect(\"/profile\")\n    }\n  })\n\n  // Signup\n  app.get(\"/signup\", (req, res) => res.render(\"signup\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY\n  }))\n\n  app.post(\"/signup\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-signup\", {\n    successRedirect: \"/profile\",\n    failureRedirect: \"/signup\"\n  }))\n\n  // Profile\n  app.get(\"/profile\", isLoggedIn, (req, res) => {\n    let redirectUrl = `/user/${req.user.username}`\n    res.redirect(redirectUrl)\n  })\n\n  app.get(\"/user/:username\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      console.log(doc)\n      res.render(\"profile\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: req.isAuthenticated() ? doc.username === req.user.username : false,\n        check,\n      })\n    }\n  })\n\n  app.get(\"/user/:username/edit\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      if (!(req.user.flags.includes(\"sudo\") || req.user.username == doc.username)) {\n        return res.render(\"404\", {\n          isAuth: req.isAuthenticated(),\n          user: req.user,\n          profile: null,\n        })\n      }\n      console.log(doc)\n      res.render(\"user/edit\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: check(req.user, \"admin.user.edit.others\"),\n        userStuff,\n      })\n    }\n  })\n\n  app.get(\"/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\"/\")\n    })\n  })\n\n  app.get(\"/check-username-availability\", (req, res) => {\n    UserModel.find({}).then(users => {\n      let usernames = users.map(val => val.username.toLowerCase())\n      res.json(usernames)\n    })\n    .catch(err => {\n      console.warn(err)\n      res.sendStatus(500)\n    })\n  })\n\n  // About Page\n  app.get(\"/about\", (req, res) => {\n    res.render(\"about\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n\n\n  app.use(\"/gloc/\", require(\"./gloc\"))\n\n  app.get(\"*\", (req, res) => {\n    res.render(\"404\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n}\n\nfunction isLoggedIn(req, res, next) {\n  // if user is authenticated in the session, carry on \n  if (req.isAuthenticated())\n    return next()\n  // if they aren't redirect them to the home page\n  res.redirect(\"/\")\n}"],"names":["recaptcha","postMiddleware","require","check","module","exports","app","passport","UserModel","get","req","res","render","isAuth","isAuthenticated","user","redirect","process","env","PRIVACY_URL","TOS_URL","message","flash","recaptcha_key","RECAPTCHA_KEY","post","middleware","verify","authenticate","failureRedirect","failureFlash","console","log","query","successRedirect","isLoggedIn","redirectUrl","username","profile","params","doc","findOne","isRoot","flags","includes","userStuff","logout","find","then","users","usernames","map","val","toLowerCase","json","catch","err","warn","sendStatus","use","next"],"mappings":"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"}