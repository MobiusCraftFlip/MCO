{"version":3,"sources":["../../src/routes/routes.js"],"sourcesContent":["const {recaptcha, postMiddleware} = require(\"../config/recaptcha.config\")\n\nmodule.exports = (app, passport, UserModel) => {\n\n  require(\"./admin\")(app, passport, UserModel)\n  require(\"./roblox\")(app, passport, UserModel)\n  require(\"./discord\")(app, passport, UserModel)\n\n  // Home Page\n  app.get(\"/\", (req, res) => res.render(\"home\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user\n  }))\n  // Home Page\n  app.get(\"/privacy\", (req, res) => res.redirect(process.env.PRIVACY_URL))\n  \n  app.get(\"/termsofservice\", (req, res) => res.redirect(process.env.TOS_URL))\n\n  // Login\n  app.get(\"/login\", (req, res) => res.render(\"login\", {\n    message: req.flash(\"loginMessage\"),\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY\n  }))\n\n  app.post(\"/login\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-login\", {\n    successRedirect: \"/profile\", // redirect to the secure profile section\n    failureRedirect: \"/login\", // redirect back to the signup page if there is an error\n    failureFlash: true // allow flash messages\n  }))\n\n  // Signup\n  app.get(\"/signup\", (req, res) => res.render(\"signup\", {\n    isAuth: req.isAuthenticated(),\n    user: req.user,\n    recaptcha_key: process.env.RECAPTCHA_KEY\n  }))\n\n  app.post(\"/signup\", recaptcha.middleware.verify, postMiddleware, passport.authenticate(\"local-signup\", {\n    successRedirect: \"/profile\",\n    failureRedirect: \"/signup\"\n  }))\n\n  // Profile\n  app.get(\"/profile\", isLoggedIn, (req, res) => {\n    let redirectUrl = `/user/${req.user.username}`\n    res.redirect(redirectUrl)\n  })\n\n  app.get(\"/user/:username\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      console.log(doc)\n      res.render(\"profile\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: req.isAuthenticated() ? doc.username === req.user.username : false\n      })\n    }\n  })\n\n  app.get(\"/user/:username/edit\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    }\n    let username = req.params.username\n    const doc = await UserModel.findOne({\n      username\n    })\n    if (!doc)\n      res.render(\"404\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: null,\n      })\n    else {\n      if (!(req.user.flags.includes(\"sudo\") || req.user.username == doc.username)) {\n        return res.render(\"404\", {\n          isAuth: req.isAuthenticated(),\n          user: req.user,\n          profile: null,\n        })\n      }\n      console.log(doc)\n      res.render(\"user/edit\", {\n        isAuth: req.isAuthenticated(),\n        user: req.user,\n        profile: doc,\n        isRoot: req.user.flags.includes(\"sudo\")\n      })\n    }\n  })\n\n  app.get(\"/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\"/\")\n    })\n  })\n\n  app.get(\"/check-username-availability\", (req, res) => {\n    UserModel.find({}).then(users => {\n      let usernames = users.map(val => val.username)\n      res.json(usernames)\n    })\n    .catch(err => {\n      console.warn(err)\n      res.sendStatus(500)\n    })\n  })\n\n  // About Page\n  app.get(\"/about\", (req, res) => {\n    res.render(\"about\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n\n\n  app.use(\"/gloc/\", require(\"./gloc\"))\n\n  app.get(\"*\", (req, res) => {\n    res.render(\"404\", {\n      isAuth: req.isAuthenticated(),\n      user: req.user,\n    })\n  })\n}\n\nfunction isLoggedIn(req, res, next) {\n  // if user is authenticated in the session, carry on \n  if (req.isAuthenticated())\n    return next()\n  // if they aren't redirect them to the home page\n  res.redirect(\"/\")\n}"],"names":["recaptcha","postMiddleware","require","module","exports","app","passport","UserModel","get","req","res","render","isAuth","isAuthenticated","user","redirect","process","env","PRIVACY_URL","TOS_URL","message","flash","recaptcha_key","RECAPTCHA_KEY","post","middleware","verify","authenticate","successRedirect","failureRedirect","failureFlash","isLoggedIn","redirectUrl","username","profile","params","doc","findOne","console","log","isRoot","flags","includes","logout","find","then","users","usernames","map","val","json","catch","err","warn","sendStatus","use","next"],"mappings":"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"}